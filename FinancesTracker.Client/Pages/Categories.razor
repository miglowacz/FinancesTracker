@page "/Categories"
@using FinancesTracker.Client.Services
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@inject cCategoryService CategoryService
@inject cSubcategoryService SubcategoryService
@inject cCategoryRuleService CategoryRuleService

<PageTitle>Kategorie i Podkategorie</PageTitle>

<div class="container py-4">
  <h3 class="mb-4">Zarządzanie kategoriami i podkategoriami</h3>
  <!-- Tabs navigation -->
  <ul class="nav nav-tabs mb-3" id="categoryTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "categories" ? "active" : "")"
              @onclick='() => activeTab = "categories"'
              type="button" role="tab">
        Kategorie
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link @(activeTab == "subcategories" ? "active" : "")"
              @onclick='() => activeTab = "subcategories"'
              type="button" role="tab">
        Podkategorie
      </button>
    </li>
  </ul>
  <div class="tab-content">
    <!-- Kategorie Tab -->
    <div class="tab-pane fade @(activeTab == "categories" ? "show active" : "")" role="tabpanel">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <span>Kategorie</span>
          <button class="btn btn-sm btn-success" @onclick="ShowAddCategoryForm" disabled="@showCategoryForm">Dodaj nową kategorię</button>
        </div>
        <div class="card-body">
          @if (showCategoryForm)
          {
            <div class="card mb-3 border-primary">
              <div class="card-header bg-primary text-white">
                @(mNewCategory.Id == 0 ? "Dodaj nową kategorię" : "Edytuj kategorię")
              </div>
              <div class="card-body">
                <EditForm Model="@mNewCategory" OnValidSubmit="OnValidSubmitCategory">
                  <div class="mb-3">
                    <InputText @bind-Value="mNewCategory.Name" class="form-control" placeholder="Nazwa kategorii" />
                  </div>
                  <div class="d-flex">
                    <button type="button" class="btn btn-success me-2" @onclick="ApplyCategory">Apply</button>
                    <button type="submit" class="btn btn-primary me-2">Zapisz i zamknij</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelCategoryForm">Anuluj</button>
                  </div>
                </EditForm>
              </div>
            </div>
          }
          <ul class="list-group">
            @foreach (var pCategory in mCategories) {
              <li class="list-group-item d-flex justify-content-between align-items-center">
                @pCategory.Name
                <span>
                  <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditCategory(pCategory)">Edytuj</button>
                  <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCategory(pCategory.Id)">Usuń</button>
                </span>
              </li>
            }
          </ul>
        </div>
      </div>
    </div>
    <!-- Podkategorie Tab -->
    <div class="tab-pane fade @(activeTab == "subcategories" ? "show active" : "")" role="tabpanel">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
          <span>Podkategorie</span>
          <button class="btn btn-sm btn-success" @onclick="ShowAddSubcategoryForm" disabled="@showSubcategoryForm">Dodaj nową podkategorię</button>
        </div>
        <div class="card-body">
          <!-- Filtr kategorii -->
          <div class="mb-3 row">
            <label class="col-sm-3 col-form-label">Filtruj według kategorii:</label>
            <div class="col-sm-6">
              <InputSelect @bind-Value="subcategoryFilterCategoryId" class="form-select">
                <option value="0">Wszystkie</option>
                @foreach (var cat in mCategories) {
                  <option value="@cat.Id">@cat.Name</option>
                }
              </InputSelect>
            </div>
          </div>
          <!-- Formularz dodawania/edycji podkategorii -->
          @if (showSubcategoryForm) {
            <div class="card mb-3 border-primary">
              <div class="card-header bg-primary text-white">
                @(mNewSubcategory.Id == 0 ? "Dodaj nową podkategorię" : "Edytuj podkategorię")
              </div>
              <div class="card-body">
                <EditForm Model="@mNewSubcategory" OnValidSubmit="OnValidSubmitSubcategory">
                  <div class="row g-2 mb-3">
                    <div class="col">
                      <InputText @bind-Value="mNewSubcategory.Name" class="form-control" placeholder="Nazwa podkategorii" />
                    </div>
                    <div class="col">
                      <InputSelect @bind-Value="mNewSubcategory.CategoryId" class="form-select">
                        <option value="0">Wybierz kategorię</option>
                        @foreach (var pCategory in mCategories) {
                          <option value="@pCategory.Id">@pCategory.Name</option>
                        }
                      </InputSelect>
                    </div>
                  </div>
                  <div class="d-flex">
                    <button type="button" class="btn btn-success me-2" @onclick="ApplySubcategory">Apply</button>
                    <button type="submit" class="btn btn-primary me-2">Zapisz i zamknij</button>
                    <button type="button" class="btn btn-secondary" @onclick="CancelSubcategoryForm">Anuluj</button>
                  </div>
                </EditForm>
              </div>
            </div>
          }
          <!-- Paging controls -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>Strona: @subcatPage + 1 / @subcatTotalPages</span>
            <div>
              <button class="btn btn-sm btn-outline-secondary me-1" @onclick="PrevSubcatPage" disabled="@(subcatPage == 0)">Poprzednia</button>
              <button class="btn btn-sm btn-outline-secondary" @onclick="NextSubcatPage" disabled="@(subcatPage >= subcatTotalPages - 1)">Następna</button>
            </div>
          </div>
          <ul class="list-group">
            @foreach (var pSubcategory in PagedFilteredSubcategories) {
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                  @pSubcategory.Name
                  <small class="text-muted ms-2">(@mCategories.FirstOrDefault(pCat => pCat.Id == pSubcategory.CategoryId)?.Name)</small>
                </span>
                <span>
                  <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditSubcategory(pSubcategory)">Edytuj</button>
                  <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteSubcategory(pSubcategory.Id)">Usuń</button>
                </span>
              </li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Reguły kategorii -->
  <div class="row g-4 mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
          Reguły kategorii
        </div>
        <div class="card-body">
          @if (!string.IsNullOrEmpty(ruleMessage))
          {
            <div class="alert @ruleMessageClass">@ruleMessage</div>
          }
          @if (showRuleForm)
{
  <div class="card mb-3 border-info">
    <div class="card-header bg-info text-white">
      @(mNewRule.Id == 0 ? "Dodaj nową regułę" : "Edytuj regułę")
    </div>
    <div class="card-body">
      <EditForm Model="@mNewRule" OnValidSubmit="OnValidSubmitRule">
        <div class="row g-2 mb-3">
          <div class="col-md-3">
            <InputText @bind-Value="mNewRule.Keyword" class="form-control" placeholder="Słowo kluczowe" />
          </div>
          <div class="col-md-3">
            <InputSelect @bind-Value="mNewRule.CategoryId" class="form-select">
              <option value="0">Wybierz kategorię</option>
              @foreach (var pCategory in mCategories) {
                <option value="@pCategory.Id">@pCategory.Name</option>
              }
            </InputSelect>
          </div>
          <div class="col-md-3">
            <InputSelect @bind-Value="mNewRule.SubcategoryId" class="form-select">
              <option value="0">Wybierz podkategorię</option>
              @foreach (var pSub in mSubcategories.Where(pSub => pSub.CategoryId == mNewRule.CategoryId)) {
                <option value="@pSub.Id">@pSub.Name</option>
              }
            </InputSelect>
          </div>
          <div class="col-md-2 d-flex align-items-center">
            <div class="form-check">
              <InputCheckbox @bind-Value="mNewRule.IsActive" class="form-check-input" id="isActiveRule" />
              <label class="form-check-label ms-1" for="isActiveRule">Aktywna</label>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button type="submit" class="btn btn-primary">Zapisz i zamknij</button>
          <button type="button" class="btn btn-secondary" @onclick="CancelRuleForm">Anuluj</button>
        </div>
      </EditForm>
    </div>
  </div>
}
else
{
  <button class="btn btn-sm btn-success mb-3" @onclick="ShowAddRuleForm">Dodaj nową regułę</button>
}
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Słowo kluczowe</th>
                  <th>Kategoria</th>
                  <th>Podkategoria</th>
                  <th>Aktywna</th>
                  <th>Akcje</th>
                </tr>
              </thead>
              <tbody>
                @foreach (var pRule in mRules) {
                  <tr>
                    <td>@pRule.Keyword</td>
                    <td>@mCategories.FirstOrDefault(pCat => pCat.Id == pRule.CategoryId)?.Name</td>
                    <td>@mSubcategories.FirstOrDefault(pSub => pSub.Id == pRule.SubcategoryId)?.Name</td>
                    <td>
                      <InputCheckbox @bind-Value="pRule.IsActive" @onchange="async _ => await ToggleRuleActive(pRule)" />
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditRule(pRule)">Edytuj</button>
                      <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteRule(pRule.Id)">Usuń</button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <label class="btn btn-sm btn-outline-secondary mb-0">
    Importuj z CSV
    <InputFile OnChange="OnImportCategories" accept=".csv" style="display:none" />
  </label>
</div>

@code {
  //lista kategorii
  private List<cCategory> mCategories = new();
  //lista podkategorii
  private List<cSubcategory> mSubcategories = new();
  //lista reguł kategorii
  private List<cCategoryRule> mRules = new();

  //nowa kategoria do dodania/edycji
  private cCategory mNewCategory = new();
  //nowa podkategoria do dodania/edycji
  private cSubcategory mNewSubcategory = new();
  //nowa reguła do dodania/edycji
  private cCategoryRule mNewRule = new();

  // Tabs state
  private string activeTab = "categories";

  // Paging for subcategories
  private int subcatPage = 0;
  private int subcatPageSize = 10;
  private int? subcategoryFilterCategoryId = null;
  private bool showSubcategoryForm = false;
  private bool showCategoryForm = false;
  private bool showRuleForm = false;

  private int subcatTotalPages => (int)Math.Ceiling((double)FilteredSubcategories.Count() / subcatPageSize);

  private IEnumerable<cSubcategory> FilteredSubcategories =>
      !subcategoryFilterCategoryId.HasValue || subcategoryFilterCategoryId == 0
          ? mSubcategories
          : mSubcategories.Where(s => s.CategoryId == subcategoryFilterCategoryId.Value);

  private IEnumerable<cSubcategory> PagedFilteredSubcategories =>
      FilteredSubcategories.Skip(subcatPage * subcatPageSize).Take(subcatPageSize);

  private string? ruleMessage;
  private string ruleMessageClass = "alert-success";

  protected override async Task OnInitializedAsync() {
    mCategories = await CategoryService.GetAllAsync();
    mSubcategories = await SubcategoryService.GetAllAsync();
    mRules = await CategoryRuleService.GetAllAsync();
  }

  private void EditCategory(cCategory xCat) {
    mNewCategory = new cCategory { Id = xCat.Id, Name = xCat.Name };
    showCategoryForm = true;
  }

  private async Task DeleteCategory(int xId) {
    await CategoryService.DeleteCategoryAsync(xId);
    mCategories = await CategoryService.GetAllAsync();
  }

  private void ShowAddSubcategoryForm() {
    mNewSubcategory = new();
    showSubcategoryForm = true;
  }

  private void CancelSubcategoryForm() {
    mNewSubcategory = new();
    showSubcategoryForm = false;
  }

  private void ShowAddRuleForm()
{
    mNewRule = new();
    showRuleForm = true;
}

private void CancelRuleForm()
{
    mNewRule = new();
    showRuleForm = false;
}

  private async Task OnValidSubmitCategory()
  {
    await ApplyCategory();
    mNewCategory = new();
    showCategoryForm = false;
  }

  private async Task AddOrUpdateCategory() // nie używane już w EditForm
  {
    await OnValidSubmitCategory();
  }

  private async Task ApplyCategory() {
    if (mNewCategory.Id == 0)
      await CategoryService.CreateCategoryAsync(mNewCategory);
    else
      await CategoryService.UpdateCategoryAsync(mNewCategory.Id, mNewCategory);

    mCategories = await CategoryService.GetAllAsync();
    // nie resetuj mNewCategory ani showCategoryForm tutaj, bo to robi OnValidSubmitCategory
    StateHasChanged();
  }

  private async Task ApplySubcategory() {
    if (mNewSubcategory.Id == 0)
      await SubcategoryService.CreateAsync(mNewSubcategory.CategoryId, mNewSubcategory);
    else
      await SubcategoryService.UpdateAsync(mNewSubcategory.Id, mNewSubcategory);

    mSubcategories = await SubcategoryService.GetAllAsync();
    StateHasChanged();
  }
  private void EditSubcategory(cSubcategory xSub) {
    mNewSubcategory = new cSubcategory {
      Id = xSub.Id,
      Name = xSub.Name,
      CategoryId = xSub.CategoryId
    };
    showSubcategoryForm = true;
  }

  private async Task DeleteSubcategory(int xId) {
    await SubcategoryService.DeleteAsync(xId);
    mSubcategories = await SubcategoryService.GetAllAsync();
    // Przesuń stronę wstecz, jeśli usunięcie spowodowało pustą stronę
    if (subcatPage >= subcatTotalPages)
      subcatPage = Math.Max(0, subcatTotalPages - 1);
  }


  private async Task OnValidSubmitSubcategory() {
    await ApplySubcategory();
    mNewSubcategory = new();
    showSubcategoryForm = false;
    subcatPage = 0;
  }

  private async Task AddOrUpdateRule() {
    try {
      cApiResponse? response = null;
      if (mNewRule.Id == 0)
        await CategoryRuleService.AddAsync(mNewRule);
      else
        await CategoryRuleService.UpdateAsync(mNewRule);

      mRules = await CategoryRuleService.GetAllAsync();
      mNewRule = new();

    } catch (Exception ex) {
      ruleMessage = $"Błąd: {ex.Message}";
      ruleMessageClass = "alert-danger";
    }
  
  }

  //     if (response != null && response.Success) {
  //       ruleMessage = response.Message ?? "Operacja zakończona sukcesem";
  //       ruleMessageClass = "alert-success";
  //       mRules = await CategoryRuleService.GetAllAsync();
  //       mNewRule = new();
  //     } else {
  //       ruleMessage = response?.Message ?? "Błąd operacji";
  //       ruleMessageClass = "alert-danger";
  //     }
  //   } catch (Exception ex) {
  //     ruleMessage = $"Błąd: {ex.Message}";
  //     ruleMessageClass = "alert-danger";
  //   }
  // }

  private void EditRule(cCategoryRule xRule) {
    mNewRule = new cCategoryRule { Id = xRule.Id, Keyword = xRule.Keyword, CategoryId = xRule.CategoryId, SubcategoryId = xRule.SubcategoryId, IsActive = xRule.IsActive };
    showRuleForm = true;
}

  private async Task DeleteRule(int xId) {
    var response = await CategoryRuleService.DeleteAsync(xId);
    // if (response.)
    // {
      ruleMessage = response.Message ?? "Reguła usunięta";
      ruleMessageClass = "alert-success";
      mRules = await CategoryRuleService.GetAllAsync();
    // }
    // else
    // {
    //   ruleMessage = response.Message ?? "Błąd usuwania reguły";
    //   ruleMessageClass = "alert-danger";
    // }
  }

  private async Task OnValidSubmitRule() {
    await AddOrUpdateRule();
    showRuleForm = false;
  }

  private async Task ToggleRuleActive(cCategoryRule rule)
  {
    rule.IsActive = !rule.IsActive;
    var response = await CategoryRuleService.UpdateAsync(rule);
    if (response.Success)
    {
      ruleMessage = "Status reguły zaktualizowany";
      ruleMessageClass = "alert-success";
      mRules = await CategoryRuleService.GetAllAsync();
    }
    else
    {
      ruleMessage = response.Message ?? "Błąd zmiany statusu";
      ruleMessageClass = "alert-danger";
    }
  }

  // Paging methods
  private void PrevSubcatPage() {
    if (subcatPage > 0) subcatPage--;
  }
  private void NextSubcatPage() {
    if (subcatPage < subcatTotalPages - 1) subcatPage++;
  }
  private void ShowAddCategoryForm() {
    mNewCategory = new();
    showCategoryForm = true;
  }
  private void CancelCategoryForm() {
    mNewCategory = new();
    showCategoryForm = false;
  }

  private async Task OnImportCategories(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;
        using var stream = file.OpenReadStream();
        await CategoryService.ImportFromCsvAsync(stream, SubcategoryService, CategoryRuleService);

        // Odśwież dane po imporcie
        mCategories = await CategoryService.GetAllAsync();
        mSubcategories = await SubcategoryService.GetAllAsync();
        mRules = await CategoryRuleService.GetAllAsync();
        StateHasChanged();
    }
}