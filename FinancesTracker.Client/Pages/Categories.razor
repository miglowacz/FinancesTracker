@page "/Categories"
@using FinancesTracker.Client.Services
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@inject cCategoryService CategoryService
@inject cSubcategoryService SubcategoryService
@inject cCategoryRuleService CategoryRuleService

<PageTitle>Kategorie i Podkategorie</PageTitle>

<div class="container py-4">
    <h3 class="mb-4">Zarz¹dzanie kategoriami i podkategoriami</h3>
    <div class="row g-4">
        <!-- Kategorie -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    Kategorie
                </div>
                <div class="card-body">
                    <EditForm Model="@mNewCategory" OnValidSubmit="@AddOrUpdateCategory">
                        <div class="input-group mb-3">
                            <InputText @bind-Value="mNewCategory.Name" class="form-control" placeholder="Nazwa kategorii" />
                            <button type="submit" class="btn btn-success">
                                @(mNewCategory.Id == 0 ? "Dodaj" : "Aktualizuj")
                            </button>
                        </div>
                    </EditForm>
                    <ul class="list-group">
                        @foreach (var pCategory in mCategories)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                @pCategory.Name
                                <span>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditCategory(pCategory)">Edytuj</button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCategory(pCategory.Id)">Usuñ</button>
                                </span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        <!-- Podkategorie -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    Podkategorie
                </div>
                <div class="card-body">
                    <EditForm Model="@mNewSubcategory" OnValidSubmit="@AddOrUpdateSubcategory">
                        <div class="row g-2 mb-3">
                            <div class="col">
                                <InputText @bind-Value="mNewSubcategory.Name" class="form-control" placeholder="Nazwa podkategorii" />
                            </div>
                            <div class="col">
                                <InputSelect @bind-Value="mNewSubcategory.CategoryId" class="form-select">
                                    <option value="">Wybierz kategoriê</option>
                                    @foreach (var pCategory in mCategories)
                                    {
                                        <option value="@pCategory.Id">@pCategory.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-success">
                                    @(mNewSubcategory.Id == 0 ? "Dodaj" : "Aktualizuj")
                                </button>
                            </div>
                        </div>
                    </EditForm>
                    <ul class="list-group">
                        @foreach (var pSubcategory in mSubcategories)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>
                                    @pSubcategory.Name
                                    <small class="text-muted ms-2">(@mCategories.FirstOrDefault(pCat => pCat.Id == pSubcategory.CategoryId)?.Name)</small>
                                </span>
                                <span>
                                    <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditSubcategory(pSubcategory)">Edytuj</button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteSubcategory(pSubcategory.Id)">Usuñ</button>
                                </span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Regu³y kategorii -->
    <div class="row g-4 mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    Regu³y kategorii
                </div>
                <div class="card-body">
                    <EditForm Model="@mNewRule" OnValidSubmit="@AddOrUpdateRule">
                        <div class="row g-2 mb-3">
                            <div class="col-md-4">
                                <InputText @bind-Value="mNewRule.Keyword" class="form-control" placeholder="S³owo kluczowe" />
                            </div>
                            <div class="col-md-4">
                                <InputSelect @bind-Value="mNewRule.CategoryId" class="form-select">
                                    <option value="">Wybierz kategoriê</option>
                                    @foreach (var pCategory in mCategories)
                                    {
                                        <option value="@pCategory.Id">@pCategory.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-3">
                                <InputSelect @bind-Value="mNewRule.SubcategoryId" class="form-select">
                                    <option value="">Wybierz podkategoriê</option>
                                    @foreach (var pSub in mSubcategories.Where(pSub => pSub.CategoryId == mNewRule.CategoryId))
                                    {
                                        <option value="@pSub.Id">@pSub.Name</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-1 d-grid">
                                <button type="submit" class="btn btn-success">
                                    @(mNewRule.Id == 0 ? "Dodaj" : "Aktualizuj")
                                </button>
                            </div>
                        </div>
                    </EditForm>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>S³owo kluczowe</th>
                                    <th>Kategoria</th>
                                    <th>Podkategoria</th>
                                    <th>Akcje</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var pRule in mRules)
                                {
                                    <tr>
                                        <td>@pRule.Keyword</td>
                                        <td>@mCategories.FirstOrDefault(pCat => pCat.Id == pRule.CategoryId)?.Name</td>
                                        <td>@mSubcategories.FirstOrDefault(pSub => pSub.Id == pRule.SubcategoryId)?.Name</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditRule(pRule)">Edytuj</button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteRule(pRule.Id)">Usuñ</button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    //lista kategorii
    private List<cCategory> mCategories = new();
    //lista podkategorii
    private List<cSubcategory> mSubcategories = new();
    //lista regu³ kategorii
    private List<cCategoryRule> mRules = new();

    //nowa kategoria do dodania/edycji
    private cCategory mNewCategory = new();
    //nowa podkategoria do dodania/edycji
    private cSubcategory mNewSubcategory = new();
    //nowa regu³a do dodania/edycji
    private cCategoryRule mNewRule = new();

    //funkcja inicjalizuj¹ca dane po za³adowaniu komponentu
    protected override async Task OnInitializedAsync() {
        //pobiera wszystkie kategorie
        mCategories = await CategoryService.GetAllAsync();
        //pobiera wszystkie podkategorie
        mSubcategories = await SubcategoryService.GetAllAsync();
        //pobiera wszystkie regu³y kategorii
        mRules = await CategoryRuleService.GetAllAsync();

    }

    //funkcja dodaje lub aktualizuje kategoriê
    private async Task AddOrUpdateCategory() {
        //jeœli Id kategorii jest równe 0, dodaje now¹ kategoriê
        if (mNewCategory.Id == 0)
            await CategoryService.AddAsync(mNewCategory);
        //w przeciwnym razie aktualizuje istniej¹c¹ kategoriê
        else
            await CategoryService.UpdateAsync(mNewCategory);

        //odœwie¿a listê kategorii
        mCategories = await CategoryService.GetAllAsync();
        //czyœci formularz kategorii
        mNewCategory = new();

    }

    //funkcja ustawia dane do edycji kategorii
    private void EditCategory(cCategory xCat) {
        //xCat - kategoria do edycji

        mNewCategory = new cCategory { Id = xCat.Id, Name = xCat.Name };

    }

    //funkcja usuwa kategoriê
    private async Task DeleteCategory(int xId) {
        //xId - id kategorii do usuniêcia

        await CategoryService.DeleteAsync(xId);
        //odœwie¿a listê kategorii
        mCategories = await CategoryService.GetAllAsync();

    }

    //funkcja dodaje lub aktualizuje podkategoriê
    private async Task AddOrUpdateSubcategory() {
        //jeœli Id podkategorii jest równe 0, dodaje now¹ podkategoriê
        if (mNewSubcategory.Id == 0)
            await SubcategoryService.AddAsync(mNewSubcategory);
        //w przeciwnym razie aktualizuje istniej¹c¹ podkategoriê
        else
            await SubcategoryService.UpdateAsync(mNewSubcategory);

        //odœwie¿a listê podkategorii
        mSubcategories = await SubcategoryService.GetAllAsync();
        //czyœci formularz podkategorii
        mNewSubcategory = new();

    }

    //funkcja ustawia dane do edycji podkategorii
    private void EditSubcategory(cSubcategory xSub) {
        //xSub - podkategoria do edycji

        mNewSubcategory = new cSubcategory { Id = xSub.Id, Name = xSub.Name, CategoryId = xSub.CategoryId };

    }

    //funkcja usuwa podkategoriê
    private async Task DeleteSubcategory(int xId) {
        //xId - id podkategorii do usuniêcia

        await SubcategoryService.DeleteAsync(xId);
        //odœwie¿a listê podkategorii
        mSubcategories = await SubcategoryService.GetAllAsync();

    }

    //funkcja dodaje lub aktualizuje regu³ê kategorii
    private async Task AddOrUpdateRule() {
        //jeœli Id regu³y jest równe 0, dodaje now¹ regu³ê
        if (mNewRule.Id == 0)
            await CategoryRuleService.AddAsync(mNewRule);
        //w przeciwnym razie aktualizuje istniej¹c¹ regu³ê
        else
            await CategoryRuleService.UpdateAsync(mNewRule);

        //odœwie¿a listê regu³
        mRules = await CategoryRuleService.GetAllAsync();
        //czyœci formularz regu³y
        mNewRule = new();

    }

    //funkcja ustawia dane do edycji regu³y
    private void EditRule(cCategoryRule xRule) {
        //xRule - regu³a do edycji

        mNewRule = new cCategoryRule { Id = xRule.Id, Keyword = xRule.Keyword, CategoryId = xRule.CategoryId, SubcategoryId = xRule.SubcategoryId };

    }

    //funkcja usuwa regu³ê kategorii
    private async Task DeleteRule(int xId) {
        //xId - id regu³y do usuniêcia

        await CategoryRuleService.DeleteAsync(xId);
        //odœwie¿a listê regu³
        mRules = await CategoryRuleService.GetAllAsync();

    }
}