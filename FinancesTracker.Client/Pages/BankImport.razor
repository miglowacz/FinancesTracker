@page "/bank-import"
@using FinancesTracker.Client.Services
@using FinancesTracker.Shared.DTOs.EnableBanking
@inject IEnableBankingClientService EnableBankingService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Import from Bank</PageTitle>

<h3>Import Transactions from Bank</h3>

@if (!string.IsNullOrEmpty(_errorMessage)) {
  <div class="alert alert-danger">@_errorMessage</div>
}

@if (!string.IsNullOrEmpty(_sessionId)) {
  <div class="alert alert-success">
    Successfully connected! Session ID: @_sessionId
    <button class="btn btn-primary" @onclick="FetchTransactions">Fetch Transactions</button>
  </div>

  @if (_transactions.Any()) {
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Amount</th>
          <th>Currency</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var transaction in _transactions) {
          <tr>
            <td>@transaction.Date.ToShortDateString()</td>
            <td>@transaction.Description</td>
            <td>@transaction.Amount.ToString("N2")</td>
            <td>@transaction.Currency</td>
          </tr>
        }
      </tbody>
    </table>
  }
} else {
  <div class="mb-3">
    <label for="country" class="form-label">Country</label>
    <input type="text" class="form-control" id="country" @bind="_country" placeholder="e.g., PL, DE, GB" />
  </div>

  <button class="btn btn-primary" @onclick="LoadBanks" disabled="@_isLoading">
    @(_isLoading ? "Loading..." : "Load Banks")
  </button>

  @if (_aspsps.Any()) {
    <div class="mt-3">
      <h4>Select Bank:</h4>
      <div class="list-group">
        @foreach (var aspsp in _aspsps) {
          <button class="list-group-item list-group-item-action" @onclick="() => StartAuthorization(aspsp.Name)">
            @aspsp.Name (@aspsp.Country)
          </button>
        }
      </div>
    </div>
  }
}

@code {
  private string _country = "PL";
  private List<Aspsp_DTO> _aspsps = new();
  private List<BankTransaction_DTO> _transactions = new();
  private bool _isLoading = false;
  private string _errorMessage = string.Empty;
  private string _sessionId = string.Empty;
  private string _accountId = string.Empty;

  protected override async Task OnInitializedAsync() {
    // Check for callback parameters
    var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
    var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
    
    var sessionId = query["sessionId"];
    var error = query["error"];
    var success = query["success"];

    if (!string.IsNullOrEmpty(error)) {
      _errorMessage = error;
    } else if (!string.IsNullOrEmpty(sessionId) && success == "true") {
      _sessionId = sessionId;
      // In real scenario, you'd select account from list
      _accountId = "account-id-from-selection";
    }
  }

  private async Task LoadBanks() {
    _isLoading = true;
    _errorMessage = string.Empty;
    
    try {
      _aspsps = await EnableBankingService.GetAspspsAsync(_country);
    } catch (Exception ex) {
      _errorMessage = $"Failed to load banks: {ex.Message}";
    } finally {
      _isLoading = false;
    }
  }

  private async Task StartAuthorization(string aspspName) {
    try {
      var authResponse = await EnableBankingService.StartAuthorizationAsync(aspspName, _country);
      
      // Open authorization URL in popup window
      await JS.InvokeVoidAsync("open", authResponse.Url, "_blank", "width=600,height=800");
      
      // Note: After user authorizes, bank redirects to /api/enablebanking/callback
      // which then redirects to this page with sessionId
    } catch (Exception ex) {
      _errorMessage = $"Failed to start authorization: {ex.Message}";
    }
  }

  private async Task FetchTransactions() {
    try {
      _transactions = await EnableBankingService.GetTransactionsAsync(
        _sessionId,
        _accountId,
        DateTime.UtcNow.AddMonths(-3),
        DateTime.UtcNow
      );
    } catch (Exception ex) {
      _errorMessage = $"Failed to fetch transactions: {ex.Message}";
    }
  }
}
