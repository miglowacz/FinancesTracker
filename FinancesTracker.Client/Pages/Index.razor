@page "/"
@using FinancesTracker.Client.Services
@using FinancesTracker.Shared.DTOs
@using MudBlazor
@inject cTransactionService TransactionService
@inject cAccountService AccountService
@inject cDataSeedService DataSeedService
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
  <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
    <MudText Typo="Typo.h4">Pulpit finansowy</MudText>
    <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.DataUsage" OnClick="GenerateDataAsync" Disabled="@mIsGenerating">
      @if (mIsGenerating) {
        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
        <span>Generowanie...</span>
      } else {
        <span>Generuj dane</span>
      }
    </MudButton>
  </MudStack>

  @if (mIsLoading) {
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
  } else {
    <MudGrid>
      <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Style="height:100px; border-left: 6px solid var(--mud-palette-success);">
          <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Przychody (Miesiąc)</MudText>
          <MudText Typo="Typo.h5" Color="Color.Success">@mSummary?.TotalIncome.ToString("C")</MudText>
        </MudPaper>
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Style="height:100px; border-left: 6px solid var(--mud-palette-error);">
          <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Wydatki (Miesiąc)</MudText>
          <MudText Typo="Typo.h5" Color="Color.Error">-@mSummary?.TotalExpenses.ToString("C")</MudText>
        </MudPaper>
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Style="height:100px; border-left: 6px solid var(--mud-palette-info);">
          <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Bilans</MudText>
          <MudText Typo="Typo.h5" Color="@(mSummary?.Balance >= 0 ? Color.Info : Color.Warning)">
            @mSummary?.Balance.ToString("C")
          </MudText>
        </MudPaper>
      </MudItem>
      <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="pa-4" Style="height:100px; border-left: 6px solid var(--mud-palette-primary);">
          <MudText Typo="Typo.subtitle2" Class="mud-text-secondary">Stan kont (Łącznie)</MudText>
          <MudText Typo="Typo.h5">@mTotalBalance.ToString("C")</MudText>
        </MudPaper>
      </MudItem>

      <MudItem xs="12" md="7">
        <MudPaper Class="pa-4" Style="height:450px;">
          <MudText Typo="Typo.h6" Class="mb-4">Struktura wydatków</MudText>
          @if (mChartData.Any()) {
            <MudChart ChartType="ChartType.Donut"
                      InputData="@mChartData.ToArray()"
                      InputLabels="@mChartLabels.ToArray()"
                      Width="300px" Height="300px" />
          } else {
            <MudAlert Severity="Severity.Info">Brak transakcji w tym miesiącu do wyświetlenia wykresu.</MudAlert>
          }
        </MudPaper>
      </MudItem>

      <MudItem xs="12" md="5">
        <MudPaper Class="pa-4" Style="height:450px; overflow-y: auto;">
          <MudText Typo="Typo.h6" Class="mb-4">Wydatki wg kategorii</MudText>
          <MudList T="string">
            @if (mSummary?.Categories != null) {
              @foreach (var cat in GetSortedCategories()) {
                @if (cat.Expenses < 0) {
                  <MudListItem>
                    <div class="d-flex justify-content-between">
                      <MudText>@cat.CategoryName</MudText>
                      <MudText Typo="Typo.body2" Color="Color.Error">@Math.Abs((decimal)cat.Expenses).ToString("C")</MudText>
                    </div>
                    <MudProgressLinear Color="Color.Error" Value="@GetPercentage(Math.Abs((decimal)cat.Expenses))" Class="mt-1" />
                  </MudListItem>
                }
              }
            }
          </MudList>
        </MudPaper>
      </MudItem>
    </MudGrid>
  }
</MudContainer>

@code {
  private bool mIsLoading = true;
  private bool mIsGenerating = false;
  private cSummary_DTO? mSummary;
  private decimal mTotalBalance = 0;

  private List<double> mChartData = new();
  private List<string> mChartLabels = new();

  protected override async Task OnInitializedAsync() {
    await LoadData();
  }

  private async Task LoadData() {
    mIsLoading = true;
    try {
      var now = DateTime.Now;

      var response = await TransactionService.GetSummaryAsync(now.Year, now.Month);
      if (response.Success && response.Data != null) {
        mSummary = response.Data;
        PrepareChartData();
      }

      var accResponse = await AccountService.GetAccountsAsync();
      if (accResponse.Success && accResponse.Data != null) {
        mTotalBalance = accResponse.Data.Sum(a => a.InitialBalance);
      }
    } finally {
      mIsLoading = false;
    }
  }

  private async Task GenerateDataAsync() {
    mIsGenerating = true;
    try {
      var response = await DataSeedService.GenerateDataAsync(200);
      if (response.Success) {
        Snackbar.Add(response.Message ?? "Dane zostały wygenerowane pomyślnie", Severity.Success);
        await LoadData();
      } else {
        Snackbar.Add(response.Message ?? "Błąd podczas generowania danych", Severity.Error);
      }
    } catch (Exception ex) {
      Snackbar.Add($"Błąd: {ex.Message}", Severity.Error);
    } finally {
      mIsGenerating = false;
    }
  }

  private IEnumerable<CategorySummaryDTO> GetSortedCategories() {
    if (mSummary?.Categories == null) return Enumerable.Empty<CategorySummaryDTO>();
    return mSummary.Categories.OrderBy(c => c.Expenses);
  }

  private void PrepareChartData() {
    mChartData.Clear();
    mChartLabels.Clear();

    if (mSummary?.Categories == null) return;

    foreach (var cat in mSummary.Categories) {
      decimal exp = Math.Abs(cat.Expenses);
      if (exp > 0) {
        mChartData.Add((double)exp);
        mChartLabels.Add(cat.CategoryName);
      }
    }
  }

  private double GetPercentage(decimal amount) {
    if (mSummary == null || mSummary.TotalExpenses == 0) return 0;
    return (double)(amount / mSummary.TotalExpenses * 100);
  }
}
