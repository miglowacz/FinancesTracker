@page "/transactions"
@using FinancesTracker.Client.Services
@using FinancesTracker.Shared.DTOs
@using FinancesTracker.Shared.Constants
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@inject cTransactionService TransactionService
@inject cCategoryService CategoryService
@inject IJSRuntime JSRuntime

<PageTitle>Transakcje</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Transakcje finansowe</h2>
                <button class="btn btn-primary" @onclick="ShowAddTransactionModal">
                    <i class="fas fa-plus"></i> Dodaj transakcję
                </button>
            </div>

            <!-- Filtry -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filtry</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Rok</label>
                            <select class="form-select" @bind="Filter.Year" @bind:after="OnFilterChanged">
                                <option value="">Wszystkie</option>
                                @for (int year = DateTime.Now.Year; year >= DateTime.Now.Year - 5; year--)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Miesiąc</label>
                            <select class="form-select" @bind="Filter.Month" @bind:after="OnFilterChanged">
                                <option value="">Wszystkie</option>
                                @foreach (var month in AppConstants.Months.Polish)
                                {
                                    <option value="@month.Key">@month.Value</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kategoria</label>
                            <select class="form-select" @bind="Filter.CategoryId" @bind:after="OnCategoryChanged">
                                <option value="">Wszystkie</option>
                                @if (categories != null)
                                {
                                    @foreach (var category in categories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Podkategoria</label>
                            <select class="form-select" @bind="Filter.SubcategoryId" @bind:after="OnFilterChanged">
                                <option value="">Wszystkie</option>
                                @if (subcategories != null)
                                {
                                    @foreach (var subcategory in subcategories)
                                    {
                                        <option value="@subcategory.Id">@subcategory.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Szukaj</label>
                            <input type="text" class="form-control" @bind="Filter.SearchTerm" @onkeypress="OnSearchKeyPress" placeholder="Szukaj w opisie...">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kwota od</label>
                            <input type="number" class="form-control" @bind="Filter.MinAmount" @bind:after="OnFilterChanged" step="0.01">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Kwota do</label>
                            <input type="number" class="form-control" @bind="Filter.MaxAmount" @bind:after="OnFilterChanged" step="0.01">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista transakcji -->
            @if (isLoading)
            {
                <div class="text-center p-4">
                    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
                </div>
            }
            else if (transactions?.Items?.Any() == true)
            {
                <MudPaper Class="pa-4">
                    <MudTable Items="transactions.Items" Hover="true" Dense="true" Bordered="true" Striped="true">
                        <HeaderContent>
                            <MudTh>
                                <MudTableSortLabel T="string"
                                    Active="@(Filter.SortBy == nameof(TransactionDto.Date))"
                                    Direction="@(Filter.SortBy == nameof(TransactionDto.Date) && Filter.SortDescending ? SortDirection.Descending : SortDirection.Ascending)"
                                    OnClick="() => SortBy(nameof(TransactionDto.Date))">
                                    Data
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh>
                                <MudTableSortLabel T="string"
                                    Active="@(Filter.SortBy == nameof(TransactionDto.Description))"
                                    Direction="@(Filter.SortBy == nameof(TransactionDto.Description) && Filter.SortDescending ? SortDirection.Descending : SortDirection.Ascending)"
                                    OnClick="() => SortBy(nameof(TransactionDto.Description))">
                                    Opis
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh>
                                <MudTableSortLabel T="string"
                                    Active="@(Filter.SortBy == nameof(TransactionDto.Amount))"
                                    Direction="@(Filter.SortBy == nameof(TransactionDto.Amount) && Filter.SortDescending ? SortDirection.Descending : SortDirection.Ascending)"
                                    OnClick="() => SortBy(nameof(TransactionDto.Amount))">
                                    Kwota
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh>
                                <MudTableSortLabel T="string"
                                    Active="@(Filter.SortBy == nameof(TransactionDto.CategoryName))"
                                    Direction="@(Filter.SortBy == nameof(TransactionDto.CategoryName) && Filter.SortDescending ? SortDirection.Descending : SortDirection.Ascending)"
                                    OnClick="() => SortBy(nameof(TransactionDto.CategoryName))">
                                    Kategoria
                                </MudTableSortLabel>
                            </MudTh>
                            <MudTh>Podkategoria</MudTh>
                            <MudTh>Bank</MudTh>
                            <MudTh>Akcje</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Data">@context.Date.ToString("dd.MM.yyyy")</MudTd>
                            <MudTd DataLabel="Opis">@context.Description</MudTd>
                            <MudTd DataLabel="Kwota">
                                <span class="@(context.Amount >= 0 ? "text-success" : "text-danger")">
                                    @context.Amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("pl-PL"))
                                </span>
                            </MudTd>
                            <MudTd DataLabel="Kategoria">@context.CategoryName</MudTd>
                            <MudTd DataLabel="Podkategoria">@context.SubcategoryName</MudTd>
                            <MudTd DataLabel="Bank">@context.BankName</MudTd>
                            <MudTd DataLabel="Akcje">
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="() => EditTransaction(context)">
                                    <MudIcon Icon="@Icons.Material.Filled.Edit" />
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="() => DeleteTransaction(context.Id)">
                                    <MudIcon Icon="@Icons.Material.Filled.Delete" />
                                </MudButton>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>

                    @if (transactions.TotalPages > 1)
                    {
                        <MudPagination Page="@Filter.PageNumber"
                                       PageSize="@Filter.PageSize"
                                       TotalItems="@transactions.TotalCount"
                                       OnPageChanged="@(async (int page) => await ChangePage(page))"
                                       HideNext="false"
                                       HidePrev="false"
                                       HideFirst="false"
                                       HideLast="false"
                                       Class="mt-4 justify-content-center" />
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Strona @Filter.PageNumber z @transactions.TotalPages 
                                (wyświetlane @((Filter.PageNumber - 1) * Filter.PageSize + 1)-@Math.Min(Filter.PageNumber * Filter.PageSize, transactions.TotalCount) 
                                z @transactions.TotalCount transakcji)
                            </small>
                        </div>
                    }
                </MudPaper>
            }
            else
            {
                <MudPaper Class="pa-4 text-center">
                    <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Color="Color.Default" Class="mb-3" />
                    <h5 class="text-muted">Brak transakcji</h5>
                    <p class="text-muted">Nie znaleziono transakcji spełniających kryteria wyszukiwania.</p>
                </MudPaper>
            }
        </div>
    </div>
</div>

@code {
    private PagedResult<TransactionDto> transactions = new();
    private List<cCategory_DTO> categories = new();
    private List<cSubcategory_DTO> subcategories = new();
    private TransactionFilterDto Filter = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        await LoadTransactions();
    }

    private async Task LoadCategories()
    {
        try
        {
            var resp = await CategoryService.GetCategoriesAsync();
            if (!resp.Success)
            {
                Console.WriteLine($"Błąd podczas ładowania kategorii: {BuildErrorMessage(resp)}");
                categories = new();
                return;
            }

            categories = resp.Data ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd podczas ładowania kategorii: {ex.Message}");
            categories = new();
        }
    }

    private async Task LoadTransactions()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            var resp = await TransactionService.GetTransactionsAsync(Filter);
            if (!resp.Success)
            {
                Console.WriteLine($"Błąd podczas ładowania transakcji: {BuildErrorMessage(resp)}");
                transactions = new PagedResult<TransactionDto>();
            }
            else
            {
                transactions = resp.Data ?? new PagedResult<TransactionDto>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Błąd podczas ładowania transakcji: {ex.Message}");
            transactions = new PagedResult<TransactionDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnFilterChanged()
    {
        Filter.PageNumber = 1;
        await LoadTransactions();
    }

    private async Task OnCategoryChanged()
    {
        if (Filter.CategoryId.HasValue)
        {
            var selectedCategory = categories.FirstOrDefault(c => c.Id == Filter.CategoryId.Value);
            subcategories = selectedCategory?.Subcategories ?? new List<cSubcategory_DTO>();
        }
        else
        {
            subcategories = new List<cSubcategory_DTO>();
        }

        Filter.SubcategoryId = null;
        Filter.PageNumber = 1;
        await LoadTransactions();
    }

    private async Task OnSearchKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Filter.PageNumber = 1;
            await LoadTransactions();
        }
    }

    private async Task SortBy(string sortBy)
    {
        if (Filter.SortBy == sortBy)
        {
            Filter.SortDescending = !Filter.SortDescending;
        }
        else
        {
            Filter.SortBy = sortBy;
            Filter.SortDescending = true;
        }
        
        await LoadTransactions();
    }

    private async Task ChangePage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= transactions.TotalPages)
        {
            Filter.PageNumber = pageNumber;
            await LoadTransactions();
        }
    }

    private async Task ShowAddTransactionModal()
    {
        await JSRuntime.InvokeVoidAsync("showModal", "addTransactionModal");
    }

    private async Task EditTransaction(TransactionDto transaction)
    {
        await JSRuntime.InvokeVoidAsync("showEditModal", transaction.Id);
    }

private async Task DeleteTransaction(int transactionId)
{
    bool confirmDelete = await JSRuntime.InvokeAsync<bool>("confirm", "Czy na pewno chcesz usunąć tę transakcję?");
    if (!confirmDelete)
        return;

    try
    {
        var resp = await TransactionService.DeleteTransactionAsync(transactionId);

        // Jawne rzutowanie, aby odczytać właściwość Success (uniknięcie kolizji ze statyczną metodą Success)
        if (!((ApiResponse<object>)resp).Success)
        {
            var msg = resp.Message ?? (resp.Errors is { Count: > 0 }
                ? string.Join(", ", resp.Errors)
                : "Nie udało się usunąć transakcji.");

            Console.WriteLine($"Błąd podczas usuwania transakcji: {msg}");
            await JSRuntime.InvokeVoidAsync("alert", $"Wystąpił błąd podczas usuwania transakcji: {msg}");
            return;
        }

        await LoadTransactions();
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Błąd podczas usuwania transakcji: {ex.Message}");
        await JSRuntime.InvokeVoidAsync("alert", "Wystąpił błąd podczas usuwania transakcji.");
    }
}
private static string BuildErrorMessage<T>(ApiResponse<T> resp)
        => resp.Message ?? ((resp.Errors != null && resp.Errors.Count > 0) ? string.Join(", ", resp.Errors) : "Wystąpił błąd.");

    private static string BuildErrorMessage(ApiResponse resp)
        => BuildErrorMessage<object>(resp);
}
