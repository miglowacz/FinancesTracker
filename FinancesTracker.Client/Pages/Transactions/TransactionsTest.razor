@page "/transactions"
@using FinancesTracker.Client.Services
@using FinancesTracker.Shared.DTOs
@using FinancesTracker.Shared.Constants
@using Microsoft.AspNetCore.Components.Web
@using MudBlazor
@inject cTransactionService TransactionService
@inject cCategoryService CategoryService
@inject IJSRuntime JSRuntime

<MudContainer MaxWidth="MaxWidth.False" Class="pa-0">
  <MudGrid>
    <MudItem xs="12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Transakcje finansowe</h2>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ms-2" OnClick="AddTransaction">
          <MudIcon Icon="@Icons.Material.Filled.Add" /> Dodaj transakcję
        </MudButton>
      </div>
    </MudItem>

    <!-- Filtry dat -->
    <MudItem xs="12">
      <MudCard Class="mb-4">
        <MudCardHeader>
          <MudText Typo="Typo.h6">Filtruj według daty</MudText>
        </MudCardHeader>
        <MudCardContent>
          <MudGrid>
            <MudItem xs="12" md="3">
              <MudDatePicker Label="Data od"
                             @bind-Date="mStartDate"
                             Placeholder="Wybierz datę początkową"
                             Editable="true"
                             DateFormat="dd.MM.yyyy"
                             Clearable="true" />
            </MudItem>
            <MudItem xs="12" md="3">
              <MudDatePicker Label="Data do"
                             @bind-Date="mEndDate"
                             Placeholder="Wybierz datę końcową"
                             Editable="true"
                             DateFormat="dd.MM.yyyy"
                             Clearable="true" />
            </MudItem>
            <MudItem xs="12" md="6" Class="d-flex align-items-center gap-2">
              <MudButton Variant="Variant.Filled"
                         Color="Color.Primary"
                         OnClick="ApplyFilters"
                         StartIcon="@Icons.Material.Filled.Search">
                Szukaj
              </MudButton>
              <MudButton Variant="Variant.Outlined"
                         Color="Color.Secondary"
                         OnClick="ClearFilters"
                         StartIcon="@Icons.Material.Filled.Clear">
                Wyczyść
              </MudButton>
            </MudItem>
          </MudGrid>

          <!-- Szybkie filtry dat -->
          <MudDivider Class="my-3" />
          <MudText Typo="Typo.subtitle2" Class="mb-2">Szybkie filtry:</MudText>
          <MudGrid>
            <MudItem xs="12" Class="d-flex flex-wrap gap-2">
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetToday">
                Dziś
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetYesterday">
                Wczoraj
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetThisWeek">
                Ten tydzień
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetLastWeek">
                Ostatni tydzień
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetThisMonth">
                Bieżący miesiąc
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetLastMonth">
                Poprzedni miesiąc
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetLast30Days">
                Ostatnie 30 dni
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetLast90Days">
                Ostatnie 90 dni
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetThisYear">
                Ten rok
              </MudButton>
              <MudButton Variant="Variant.Text"
                         Size="Size.Small"
                         OnClick="SetLastYear">
                Poprzedni rok
              </MudButton>
            </MudItem>
          </MudGrid>
        </MudCardContent>
      </MudCard>
    </MudItem>

    <!-- Wyświetlanie aktywnego filtra -->
    @if (mStartDate.HasValue || mEndDate.HasValue) {
      <MudItem xs="12">
        <MudAlert Severity="Severity.Info" Dense="true" ShowCloseIcon="true" CloseIconClicked="ClearFilters">
          <MudText Typo="Typo.body2">
            <strong>Aktywny filtr:</strong>
            @if (mStartDate.HasValue && mEndDate.HasValue) {
              <span>od @mStartDate.Value.ToString("dd.MM.yyyy") do @mEndDate.Value.ToString("dd.MM.yyyy")</span>
            } else if (mStartDate.HasValue) {
              <span>od @mStartDate.Value.ToString("dd.MM.yyyy")</span>
            } else if (mEndDate.HasValue) {
              <span>do @mEndDate.Value.ToString("dd.MM.yyyy")</span>
            }
          </MudText>
        </MudAlert>
      </MudItem>
    }

    <!-- Lista transakcji -->
    <MudItem xs="12">
      @if (mIsLoading) {
        <div class="text-center p-4">
          <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
          <MudText Typo="Typo.body1" Class="mt-3">Ładowanie transakcji...</MudText>
        </div>
      } else if (Transactions.Items?.Any() == true) {
        <MudPaper Class="pa-4">
          <MudText Typo="Typo.subtitle2" Class="mb-3">
            Znaleziono @Transactions.TotalCount transakcji
          </MudText>
          <MudTable Items="Transactions.Items" Hover="true" Dense="true" Bordered="true" Striped="true">
            <HeaderContent>
              <MudTh>Data</MudTh>
              <MudTh>Kwota</MudTh>
              <MudTh>Opis</MudTh>
              <MudTh>Kategoria</MudTh>
              <MudTh>Bank</MudTh>
            </HeaderContent>
            <RowTemplate>
              <MudTd DataLabel="Data">@context.Date.ToString("dd.MM.yyyy")</MudTd>
              <MudTd DataLabel="Kwota">
                <span class="@(context.Amount >= 0 ? "text-success fw-bold" : "text-danger fw-bold")">
                  @context.Amount.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("pl-PL"))
                </span>
              </MudTd>
              <MudTd DataLabel="Opis">@context.Description</MudTd>
              <MudTd DataLabel="Kategoria">@context.CategoryName</MudTd>
              <MudTd DataLabel="Bank">@context.BankName</MudTd>
            </RowTemplate>
          </MudTable>

          <!-- Paginacja -->
          @if (Transactions.TotalPages > 1) {
            <MudDivider Class="my-3" />
            <div class="d-flex justify-content-between align-items-center">
              <MudText Typo="Typo.body2">
                Strona @Transactions.PageNumber z @Transactions.TotalPages
              </MudText>
              <div class="d-flex gap-2">
                <MudButton Variant="Variant.Outlined"
                           Size="Size.Small"
                           Disabled="@(!Transactions.HasPreviousPage)"
                           OnClick="PreviousPage">
                  Poprzednia
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Size="Size.Small"
                           Disabled="@(!Transactions.HasNextPage)"
                           OnClick="NextPage">
                  Następna
                </MudButton>
              </div>
            </div>
          }
        </MudPaper>
      } else {
        <MudPaper Class="pa-4 text-center">
          <MudIcon Icon="@Icons.Material.Filled.Inbox" Size="Size.Large" Color="Color.Default" Class="mb-3" />
          <MudText Typo="Typo.h6" Class="text-muted">Brak transakcji</MudText>
          <MudText Typo="Typo.body2" Class="text-muted">
            Nie znaleziono transakcji dla wybranych kryteriów.
          </MudText>
        </MudPaper>
      }
    </MudItem>
  </MudGrid>
</MudContainer>

@code {
  PagedResult<TransactionDto> Transactions = new();

  private DateTime? mStartDate;
  private DateTime? mEndDate;
  private bool mIsLoading = false;
  private TransactionFilterDto mFilter = new();

  protected override async Task OnInitializedAsync() {
    // Domyślnie załaduj transakcje z bieżącego miesiąca
    SetThisMonth();
    await LoadTransactions();
  }

  private async Task LoadTransactions() {
    mIsLoading = true;
    StateHasChanged();

    try {
      // Aktualizuj filtr datami
      mFilter.StartDate = mStartDate;
      mFilter.EndDate = mEndDate;

      var pResp = await TransactionService.GetTransactionsAsync(mFilter);
      if (!pResp.Success) {
        Console.WriteLine($"Błąd podczas ładowania transakcji: {BuildErrorMessage(pResp)}");
        Transactions = new PagedResult<TransactionDto>();
      } else {
        Transactions = pResp.Data ?? new PagedResult<TransactionDto>();
      }
    } catch (Exception pEx) {
      Console.WriteLine($"Błąd podczas ładowania transakcji: {pEx.Message}");
      Transactions = new PagedResult<TransactionDto>();
    } finally {
      mIsLoading = false;
      StateHasChanged();
    }
  }

  private async Task ApplyFilters() {
    mFilter.PageNumber = 1; // Resetuj do pierwszej strony
    await LoadTransactions();
  }

  private async Task ClearFilters() {
    mStartDate = null;
    mEndDate = null;
    mFilter = new TransactionFilterDto();
    await LoadTransactions();
  }

  // Szybkie filtry dat
  private async Task SetToday() {
    mStartDate = DateTime.Today;
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetYesterday() {
    mStartDate = DateTime.Today.AddDays(-1);
    mEndDate = DateTime.Today.AddDays(-1);
    await ApplyFilters();
  }

  private async Task SetThisWeek() {
    var today = DateTime.Today;
    var dayOfWeek = (int)today.DayOfWeek;
    var startOfWeek = today.AddDays(-(dayOfWeek == 0 ? 6 : dayOfWeek - 1));
    mStartDate = startOfWeek;
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetLastWeek() {
    var today = DateTime.Today;
    var dayOfWeek = (int)today.DayOfWeek;
    var startOfLastWeek = today.AddDays(-(dayOfWeek == 0 ? 6 : dayOfWeek - 1) - 7);
    mStartDate = startOfLastWeek;
    mEndDate = startOfLastWeek.AddDays(6);
    await ApplyFilters();
  }

  private async Task SetThisMonth() {
    var today = DateTime.Today;
    mStartDate = new DateTime(today.Year, today.Month, 1);
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetLastMonth() {
    var today = DateTime.Today;
    var firstDayOfLastMonth = new DateTime(today.Year, today.Month, 1).AddMonths(-1);
    mStartDate = firstDayOfLastMonth;
    mEndDate = firstDayOfLastMonth.AddMonths(1).AddDays(-1);
    await ApplyFilters();
  }

  private async Task SetLast30Days() {
    mStartDate = DateTime.Today.AddDays(-30);
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetLast90Days() {
    mStartDate = DateTime.Today.AddDays(-90);
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetThisYear() {
    var today = DateTime.Today;
    mStartDate = new DateTime(today.Year, 1, 1);
    mEndDate = DateTime.Today;
    await ApplyFilters();
  }

  private async Task SetLastYear() {
    var today = DateTime.Today;
    mStartDate = new DateTime(today.Year - 1, 1, 1);
    mEndDate = new DateTime(today.Year - 1, 12, 31);
    await ApplyFilters();
  }

  // Paginacja
  private async Task PreviousPage() {
    if (Transactions.HasPreviousPage) {
      mFilter.PageNumber--;
      await LoadTransactions();
    }
  }

  private async Task NextPage() {
    if (Transactions.HasNextPage) {
      mFilter.PageNumber++;
      await LoadTransactions();
    }
  }

  private async Task AddTransaction(MouseEventArgs args) {
    await JSRuntime.InvokeVoidAsync("alert", "Dodaj transakcję - funkcja w budowie!");
  }

  private static string BuildErrorMessage<T>(ApiResponse<T> xResp)
    => xResp.Message ?? ((xResp.Errors != null && xResp.Errors.Count > 0) ? string.Join(", ", xResp.Errors) : "Wystąpił błąd.");
}
