@page "/import"
@using FinancesTracker.Client.Services
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@inject IJSRuntime JS
@inject NavigationManager Navigation
@inject TransactionImportService ImportService

<div class="container mt-4">
  <h3>Import transakcji</h3>

  <div class="mb-3">
    <label class="form-label">Wybierz bank:</label>
    <div class="btn-group" role="group">
      <input type="radio" class="btn-check" name="bankOption" id="mbankRadio" value="mbank" @onchange="OnBankChanged" checked="@(selectedBank == "mbank")" />
      <label class="btn btn-outline-primary" for="mbankRadio">mBank</label>

      <input type="radio" class="btn-check" name="bankOption" id="millenniumRadio" value="millennium" @onchange="OnBankChanged" checked="@(selectedBank == "millennium")" />
      <label class="btn btn-outline-primary" for="millenniumRadio">Millennium</label>
    </div>
  </div>

  <label class="btn btn-sm btn-outline-secondary mb-0">
    Importuj z CSV
    <InputFile OnChange="OnFileSelected" accept=".csv" style="display:none" />
  </label>

  @if (isImporting) {
    <div class="mt-3">
      <div class="spinner-border spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Ładowanie...</span>
      </div>
      <span>Importowanie...</span>
    </div>
  }
  @if (!string.IsNullOrEmpty(message)) {
    <div class="alert alert-info mt-3">@message</div>
  }
</div>

@code {
  private bool isImporting = false;
  private string? message;
  private string selectedBank = "mbank";

  private void OnBankChanged(ChangeEventArgs e) {
    selectedBank = e.Value?.ToString() ?? "mbank";
    message = null;
  }

  private async Task OnFileSelected(InputFileChangeEventArgs e) {
    isImporting = true;
    message = null;

    var file = e.File;
    if (file == null) {
      isImporting = false;
      message = "Nie wybrano pliku.";
      return;
    }

    try {
      using var stream = file.OpenReadStream();
      List<cTransaction> transactions;

      if (selectedBank == "millennium") {
        transactions = await ImportService.ImportFromMillenniumCsvAsync(stream);
      }
      else {
        transactions = await ImportService.ImportFromMbankCsvAsync(stream);
      }

      var result = await ImportService.ImportTransactionsAsync(transactions, selectedBank);
      message = result
        ? $"Transakcje zostały zaimportowane! (Bank: {selectedBank})"
        : "Błąd podczas importu transakcji.";
    }
    catch (Exception ex) {
      message = $"Błąd importu: {ex.Message}";
    }
    isImporting = false;
  }
}
